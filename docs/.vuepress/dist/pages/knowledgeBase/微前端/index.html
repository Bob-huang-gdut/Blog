<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微前端的核心和本质 | 黄思博 blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/images/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <meta name="description" content="前端工程师,前端自学,高级前端工程师,中高级前端工程师,前端进阶知识,前端职业发展">
    
    <link rel="preload" href="/blog/assets/css/0.styles.9ccbfcc4.css" as="style"><link rel="preload" href="/blog/assets/js/app.88154504.js" as="script"><link rel="preload" href="/blog/assets/js/2.312bc144.js" as="script"><link rel="preload" href="/blog/assets/js/62.9e462aef.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.570970db.js"><link rel="prefetch" href="/blog/assets/js/11.f89870f4.js"><link rel="prefetch" href="/blog/assets/js/12.d49e01fb.js"><link rel="prefetch" href="/blog/assets/js/13.139c024c.js"><link rel="prefetch" href="/blog/assets/js/14.a6f9405d.js"><link rel="prefetch" href="/blog/assets/js/15.34a018f8.js"><link rel="prefetch" href="/blog/assets/js/16.40aaab29.js"><link rel="prefetch" href="/blog/assets/js/17.09dbff65.js"><link rel="prefetch" href="/blog/assets/js/18.241795e2.js"><link rel="prefetch" href="/blog/assets/js/19.b92847c0.js"><link rel="prefetch" href="/blog/assets/js/20.53721a79.js"><link rel="prefetch" href="/blog/assets/js/21.5f6bad0d.js"><link rel="prefetch" href="/blog/assets/js/22.17abea52.js"><link rel="prefetch" href="/blog/assets/js/23.ed57d266.js"><link rel="prefetch" href="/blog/assets/js/24.f7f838f9.js"><link rel="prefetch" href="/blog/assets/js/25.3543ae51.js"><link rel="prefetch" href="/blog/assets/js/26.d0598105.js"><link rel="prefetch" href="/blog/assets/js/27.45aa3f9d.js"><link rel="prefetch" href="/blog/assets/js/28.47b18bdc.js"><link rel="prefetch" href="/blog/assets/js/29.c7d3e56f.js"><link rel="prefetch" href="/blog/assets/js/3.a069f181.js"><link rel="prefetch" href="/blog/assets/js/30.4d3e04e6.js"><link rel="prefetch" href="/blog/assets/js/31.a83b8314.js"><link rel="prefetch" href="/blog/assets/js/32.dd0e381e.js"><link rel="prefetch" href="/blog/assets/js/33.0df5aecf.js"><link rel="prefetch" href="/blog/assets/js/34.c10e7e08.js"><link rel="prefetch" href="/blog/assets/js/35.4f561628.js"><link rel="prefetch" href="/blog/assets/js/36.30717414.js"><link rel="prefetch" href="/blog/assets/js/37.d8b08806.js"><link rel="prefetch" href="/blog/assets/js/38.b80b22ad.js"><link rel="prefetch" href="/blog/assets/js/39.d390130d.js"><link rel="prefetch" href="/blog/assets/js/4.8f39d83d.js"><link rel="prefetch" href="/blog/assets/js/40.48ac5acb.js"><link rel="prefetch" href="/blog/assets/js/41.d12fb05c.js"><link rel="prefetch" href="/blog/assets/js/42.93b4e1d5.js"><link rel="prefetch" href="/blog/assets/js/43.b831179b.js"><link rel="prefetch" href="/blog/assets/js/44.bbd304d3.js"><link rel="prefetch" href="/blog/assets/js/45.243752a8.js"><link rel="prefetch" href="/blog/assets/js/46.970cd652.js"><link rel="prefetch" href="/blog/assets/js/47.0eccc6b9.js"><link rel="prefetch" href="/blog/assets/js/48.a710e0a3.js"><link rel="prefetch" href="/blog/assets/js/49.b99b6564.js"><link rel="prefetch" href="/blog/assets/js/5.6855e47f.js"><link rel="prefetch" href="/blog/assets/js/50.f471ea86.js"><link rel="prefetch" href="/blog/assets/js/51.50739b05.js"><link rel="prefetch" href="/blog/assets/js/52.62e5e0e3.js"><link rel="prefetch" href="/blog/assets/js/53.73f1fbb0.js"><link rel="prefetch" href="/blog/assets/js/54.ce42cb03.js"><link rel="prefetch" href="/blog/assets/js/55.268007a6.js"><link rel="prefetch" href="/blog/assets/js/56.771f3439.js"><link rel="prefetch" href="/blog/assets/js/57.e2507c13.js"><link rel="prefetch" href="/blog/assets/js/58.7a67f94f.js"><link rel="prefetch" href="/blog/assets/js/59.5fd64daf.js"><link rel="prefetch" href="/blog/assets/js/6.185609d6.js"><link rel="prefetch" href="/blog/assets/js/60.470a7977.js"><link rel="prefetch" href="/blog/assets/js/61.c1a85c44.js"><link rel="prefetch" href="/blog/assets/js/63.9d45757d.js"><link rel="prefetch" href="/blog/assets/js/64.f6861c2e.js"><link rel="prefetch" href="/blog/assets/js/65.9748d5e5.js"><link rel="prefetch" href="/blog/assets/js/66.95b6a020.js"><link rel="prefetch" href="/blog/assets/js/67.a20bcd0e.js"><link rel="prefetch" href="/blog/assets/js/68.47f1c438.js"><link rel="prefetch" href="/blog/assets/js/69.657f5177.js"><link rel="prefetch" href="/blog/assets/js/7.5942b600.js"><link rel="prefetch" href="/blog/assets/js/70.92bb2dbf.js"><link rel="prefetch" href="/blog/assets/js/71.846199c5.js"><link rel="prefetch" href="/blog/assets/js/72.b550d947.js"><link rel="prefetch" href="/blog/assets/js/73.7de43cd5.js"><link rel="prefetch" href="/blog/assets/js/74.ea2f9b45.js"><link rel="prefetch" href="/blog/assets/js/75.69485c7d.js"><link rel="prefetch" href="/blog/assets/js/76.697bbbef.js"><link rel="prefetch" href="/blog/assets/js/77.5c26b123.js"><link rel="prefetch" href="/blog/assets/js/78.8581694b.js"><link rel="prefetch" href="/blog/assets/js/79.15335ef7.js"><link rel="prefetch" href="/blog/assets/js/8.0c2c994c.js"><link rel="prefetch" href="/blog/assets/js/80.33b85e0f.js"><link rel="prefetch" href="/blog/assets/js/81.4b078f92.js"><link rel="prefetch" href="/blog/assets/js/82.df210e42.js"><link rel="prefetch" href="/blog/assets/js/83.b050bea9.js"><link rel="prefetch" href="/blog/assets/js/84.0ef7af8e.js"><link rel="prefetch" href="/blog/assets/js/85.63e7ca7c.js"><link rel="prefetch" href="/blog/assets/js/9.44da5142.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.9ccbfcc4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/images/logo.png" alt="黄思博 blog" class="logo"> <span class="site-name can-hide">黄思博 blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/pages/knowledgeBase/" class="nav-link router-link-active">
  知识库
</a></div><div class="nav-item"><a href="/blog/pages/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/pages/question/" class="nav-link">
  每日·一题
</a></div><div class="nav-item"><a href="/blog/pages/summary/" class="nav-link">
  个人总结
</a></div><div class="nav-item"><a href="https://github.com/Bob-huang-gdut" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/pages/knowledgeBase/" class="nav-link router-link-active">
  知识库
</a></div><div class="nav-item"><a href="/blog/pages/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/pages/question/" class="nav-link">
  每日·一题
</a></div><div class="nav-item"><a href="/blog/pages/summary/" class="nav-link">
  个人总结
</a></div><div class="nav-item"><a href="https://github.com/Bob-huang-gdut" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/pages/knowledgeBase/" aria-current="page" class="sidebar-link">知识库</a></li><li><a href="/blog/pages/knowledgeBase/html/" class="sidebar-link">html</a></li><li><a href="/blog/pages/knowledgeBase/nginx/" class="sidebar-link">nginx</a></li><li><a href="/blog/pages/knowledgeBase/node/" class="sidebar-link">node</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>移动端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/blog/pages/knowledgeBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="sidebar-link">设计模式</a></li><li><a href="/blog/pages/knowledgeBase/web%E8%84%9A%E6%89%8B%E6%9E%B6/" class="sidebar-link">web脚手架</a></li><li><a href="/blog/pages/knowledgeBase/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/" class="sidebar-link">数据可视化</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/blog/pages/knowledgeBase/typeScript/" class="sidebar-link">typeScript</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/blog/pages/knowledgeBase/%E6%B5%8F%E8%A7%88%E5%99%A8/" class="sidebar-link">浏览器</a></li><li><a href="/blog/pages/knowledgeBase/network/" class="sidebar-link">计算机网络</a></li><li><a href="/blog/pages/knowledgeBase/%E9%AA%A8%E6%9E%B6%E5%B1%8F/" class="sidebar-link">骨架屏</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/blog/pages/knowledgeBase/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D/" class="sidebar-link">移动端适配</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>手写代码</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端安全</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/blog/pages/knowledgeBase/docker/" class="sidebar-link">docker</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="微前端的核心和本质"><a href="#微前端的核心和本质" class="header-anchor">#</a> 微前端的核心和本质</h2> <p>微前端产生的原因，说白了是个业务问题，我们的业务项目，分久必合合久必分，一个项目合在一起太久了，等到不好维护的时候，就需要拆分，反之同理，拆的太碎的时候，合在一起更容易维护</p> <p>微前端的本质是前端路由，不需要和运维童鞋联调，而且自己还能控制生命周期，进行沙箱隔离，甚至可以状态通信</p> <p>微前端框架大致套路差不多，大概包括下面几个功能</p> <ul><li>lifeycycles</li> <li>shadow dom</li> <li>scoped css</li> <li>Proxy sandbox</li> <li>html-loader</li> <li>global store</li></ul> <h3 id="lifecycle-loop"><a href="#lifecycle-loop" class="header-anchor">#</a> lifecycle loop</h3> <p>生命周期的是 single-spa 的核心，berial 内部也复现了一组类似的循环队列</p> <h3 id="shadow-dom-scoped-css"><a href="#shadow-dom-scoped-css" class="header-anchor">#</a> shadow dom &amp; scoped css</h3> <h3 id="proxy-sandox"><a href="#proxy-sandox" class="header-anchor">#</a> proxy sandox</h3> <p>沙箱机制，是微前端框架另一个机制，大概有两种方案</p> <h3 id="html-loader"><a href="#html-loader" class="header-anchor">#</a> html-loader</h3> <p>html-loader 其实是一个 parser，然后找到 script 和 style，暴露出来</p> <h3 id="global-store"><a href="#global-store" class="header-anchor">#</a> global store</h3> <p>用于状态通信的最简机制，也是通过 Proxy 实现的，可以简单方便地在不同 APP 之间通信
然后我们还会自带一个批处理，让用户多次修改状态，mount 阶段都交替一次</p> <h3 id="webpack5-module-federation"><a href="#webpack5-module-federation" class="header-anchor">#</a> webpack5 module federation？</h3> <p>webpack5 的新特性，中文名叫做「模块联邦」，令人稍稍有点沮丧的是，这玩意完全可以实现多个不同技术栈共存，而不需要任何框架</p> <ul><li>简单 任意 js 框架均可使用。微应用接入像使用接入一个 iframe 系统一样简单，但实际不是 iframe。</li> <li>完备性 几乎包含所有构建微前端系统时所需要的基本能力，如 样式隔离、js 沙箱、预加载等。</li> <li>生产可用 已在蚂蚁内外经受过足够大量的线上系统的考验及打磨，健壮性值得信赖。</li></ul> <h2 id="什么是微前端"><a href="#什么是微前端" class="header-anchor">#</a> 什么是微前端</h2> <p>Techniques, strategies and recipes for building a modern web app with multiple teams that can ship features independently. -- Micro Frontends</p> <p>微前端是一种多个团队通过<strong>独立发布功能的方式</strong>来共同构建现代化 web 应用的技术手段及方法策略。</p> <p>微前端架构具备以下几个核心价值：</p> <ul><li><p><strong>技术栈无关</strong> 主框架不限制接入应用的技术栈，微应用具备完全自主权</p></li> <li><p><strong>独立&amp;部署</strong> 微应用仓库独立，前后端可独立开发，部署完成后主框架自动完成同步更新</p></li> <li><p><strong>增量升级</strong> 在面对各种复杂场景时，我们通常很难对一个已经存在的系统做全量的技术栈升级或重构，而微前端是一种非常好的实施渐进式重构的手段和策略</p></li> <li><p><strong>独立运行时</strong> 每个微应用之间状态隔离，运行时状态不共享</p></li></ul> <p>微前端架构旨在解决单体应用在一个相对长的时间跨度下，由于参与的人员、团队的增多、变迁，从一个普通应用演变成一个巨石应用(Frontend Monolith)后，随之而来的应用不可维护的问题。这类问题在企业级 Web 应用中尤其常见。</p> <h2 id="qiankun-的核心设计理念"><a href="#qiankun-的核心设计理念" class="header-anchor">#</a> qiankun 的核心设计理念</h2> <ul><li><p><strong>简单</strong> 由于主应用微应用都能做到技术栈无关，qiankun 对于用户而言只是一个类似 jQuery 的库，你需要调用几个 qiankun 的 API 即可完成应用的微前端改造。同时由于 qiankun 的 HTML entry 及沙箱的设计，使得微应用的接入像使用 iframe 一样简单。</p></li> <li><p>🍡 <strong>解耦/技术栈无关</strong> 微前端的核心目标是<strong>将巨石应用拆解成若干可以自治的松耦合微应用</strong>，而 qiankun 的诸多设计均是秉持这一原则，如 HTML entry、沙箱、应用间通信等。这样才能确保微应用真正具备 独立开发、独立运行 的能力。</p></li></ul> <h2 id="why-not-iframe"><a href="#why-not-iframe" class="header-anchor">#</a> Why Not Iframe</h2> <p>为什么不用 iframe，这几乎是所有微前端方案第一个会被 challenge 的问题。但是大部分微前端方案又不约而同放弃了 iframe 方案，自然是有原因的，并不是为了 &quot;炫技&quot; 或者刻意追求 &quot;特立独行&quot;。</p> <p>如果不考虑体验问题，iframe 几乎是最完美的微前端解决方案了。</p> <p>iframe <strong>最大的特性就是提供了浏览器原生的硬隔离方案</strong>，不论是样式隔离、js 隔离这类问题统统都能被完美解决。但他的<strong>最大问题也在于他的隔离性无法被突破</strong>，导致应用间上下文无法被共享，随之带来的开发体验、产品体验的问题。</p> <ul><li><strong>url 不同步</strong>。浏览器刷新 iframe url 状态丢失、后退前进按钮无法使用。</li> <li><strong>UI 不同步</strong>，DOM 结构不共享。想象一下屏幕右下角 1/4 的 iframe 里来一个带遮罩层的弹框，同时我们要求这个弹框要浏览器居中显示，还要浏览器 resize 时自动居中..</li> <li><strong>全局上下文完全隔离</strong>，内存变量不共享。iframe 内外系统的通信、数据同步等需求，主应用的 cookie 要透传到根域名都不同的子应用中实现免登效果。</li> <li><strong>慢</strong>。每次子应用进入都是一次浏览器上下文重建、资源重新加载的过程。</li></ul> <p>其中有的问题比较好解决(问题1)，有的问题我们可以睁一只眼闭一只眼(问题4)，但有的问题我们则很难解决(问题3)甚至无法解决(问题2)，而这些无法解决的问题恰恰又会给产品带来非常严重的体验问题， 最终导致我们舍弃了 iframe 方案。</p> <h2 id="特性"><a href="#特性" class="header-anchor">#</a> 特性</h2> <ul><li>📦 基于 single-spa 封装，提供了更加开箱即用的 API。</li> <li>📱 技术栈无关，任意技术栈的应用均可 使用/接入，不论是 React/Vue/Angular/JQuery 还是其他等框架。</li> <li>💪 HTML Entry 接入方式，让你接入微应用像使用 iframe 一样简单。</li> <li>🛡​ 样式隔离，确保微应用之间样式互相不干扰。</li> <li>🧳 JS 沙箱，确保微应用之间 全局变量/事件 不冲突。</li> <li>⚡️ 资源预加载，在浏览器空闲时间预加载未打开的微应用资源，加速微应用打开速度。</li> <li>🔌 umi 插件，提供了 @umijs/plugin-qiankun 供 umi 应用一键切换成微前端架构系统。</li></ul> <h2 id="上手"><a href="#上手" class="header-anchor">#</a> 上手</h2> <h3 id="主应用"><a href="#主应用" class="header-anchor">#</a> 主应用</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> registerMicroApps<span class="token punctuation">,</span> start <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'qiankun'</span><span class="token punctuation">;</span>

<span class="token function">registerMicroApps</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'react app'</span><span class="token punctuation">,</span> <span class="token comment">// app name registered</span>
    entry<span class="token operator">:</span> <span class="token string">'//localhost:7100'</span><span class="token punctuation">,</span>
    container<span class="token operator">:</span> <span class="token string">'#yourContainer'</span><span class="token punctuation">,</span>
    activeRule<span class="token operator">:</span> <span class="token string">'/yourActiveRule'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'vue app'</span><span class="token punctuation">,</span>
    entry<span class="token operator">:</span> <span class="token punctuation">{</span> scripts<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'//localhost:7100/main.js'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    container<span class="token operator">:</span> <span class="token string">'#yourContainer2'</span><span class="token punctuation">,</span>
    activeRule<span class="token operator">:</span> <span class="token string">'/yourActiveRule2'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>当微应用信息注册完之后，一旦浏览器的 url 发生变化，便会自动触发 qiankun 的匹配逻辑，所有 activeRule 规则匹配上的微应用就会被插入到指定的 container 中，同时依次调用微应用暴露出的生命周期钩子。</p> <p>如果微应用不是直接跟路由关联的时候，你也可以选择手动加载微应用的方式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> loadMicroApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'qiankun'</span><span class="token punctuation">;</span>

<span class="token function">loadMicroApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'app'</span><span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token string">'//localhost:7100'</span><span class="token punctuation">,</span>
  container<span class="token operator">:</span> <span class="token string">'#yourContainer'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="微应用"><a href="#微应用" class="header-anchor">#</a> 微应用</h3> <p>微应用不需要额外安装任何其他依赖即可接入 qiankun 主应用。</p> <p>微应用需要在自己的入口 js (通常就是你配置的 webpack 的 entry js) 导出 bootstrap、mount、unmount 三个生命周期钩子，以供主应用在适当的时机调用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * bootstrap 只会在微应用初始化的时候调用一次，下次微应用重新进入时会直接调用 mount 钩子，不会再重复触发 bootstrap。
 * 通常我们可以在这里做一些全局变量的初始化，比如不会在 unmount 阶段被销毁的应用级别的缓存等。
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'react app bootstraped'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 应用每次进入都会调用 mount 方法，通常我们在这里触发应用的渲染方法
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>container <span class="token operator">?</span> props<span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span> <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 应用每次 切出/卸载 会调用的方法，通常在这里我们会卸载微应用的应用实例
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">unmountComponentAtNode</span><span class="token punctuation">(</span>
    props<span class="token punctuation">.</span>container <span class="token operator">?</span> props<span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span> <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 可选生命周期钩子，仅使用 loadMicroApp 方式加载微应用时生效
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'update props'</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="配置微应用的打包工具"><a href="#配置微应用的打包工具" class="header-anchor">#</a> 配置微应用的打包工具</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> packageName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    library<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-[name]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    libraryTarget<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    jsonpFunction<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpackJsonp_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="api-说明"><a href="#api-说明" class="header-anchor">#</a> API 说明</h2> <h3 id="基于路由配置"><a href="#基于路由配置" class="header-anchor">#</a> 基于路由配置</h3> <ul><li>registerMicroApps(apps, lifeCycles?)</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>apps - Array&lt;RegistrableApp&gt;
app: {
  name: 'react app', // app name registered
  entry: '//localhost:7100',
  container: '#yourContainer',
  activeRule: '/yourActiveRule',
  loader: () =&gt; {}
  props: {
    a: 1
  }
}
lifeCycles: 
beforeLoad - Lifecycle | Array&lt;Lifecycle&gt; - 可选
beforeMount - Lifecycle | Array&lt;Lifecycle&gt; - 可选
afterMount - Lifecycle | Array&lt;Lifecycle&gt; - 可选
beforeUnmount - Lifecycle | Array&lt;Lifecycle&gt; - 可选
afterUnmount - Lifecycle | Array&lt;Lifecycle&gt; - 可选
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li>start(opts?)
prefetch - boolean | 'all' | string[] | (( apps: RegistrableApp[] ) =&gt; { criticalAppNames: string[]; minorAppsName: string[] }) - 可选，是否开启预加载，默认为 true。</li></ul> <p>singular - boolean | ((app: RegistrableApp<any>) =&gt; Promise<boolean>); - 可选，是否为单实例场景，单实例指的是同一时间只会渲染一个微应用。默认为 true。</boolean></any></p> <p>sandbox - boolean | { strictStyleIsolation?: boolean, experimentalStyleIsolation?: boolean } - 可选，是否开启沙箱，默认为 true。</p> <p>默认情况下沙箱可以确保单实例场景子应用之间的样式隔离，但是无法确保主应用跟子应用、或者多实例场景的子应用样式隔离。当配置为 { strictStyleIsolation: true } 时表示开启严格的样式隔离模式。这种模式下 qiankun 会为每个微应用的容器包裹上一个 shadow dom 节点，从而确保微应用的样式不会对全局造成影响。</p> <ul><li>setDefaultMountApp(appLink)</li> <li>runAfterFirstMounted(effect)</li></ul> <h3 id="手动加载"><a href="#手动加载" class="header-anchor">#</a> 手动加载</h3> <ul><li>loadMicroApp(app, configuration?)</li> <li>prefetchApps(apps, importEntryOpts?)</li> <li>addGlobalUncaughtErrorHandler(handler)</li> <li>removeGlobalUncaughtErrorHandler(handler)</li> <li>initGlobalState(state)</li></ul> <p>主应用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> initGlobalState<span class="token punctuation">,</span> MicroAppStateActions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'qiankun'</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化 state</span>
<span class="token keyword">const</span> actions<span class="token operator">:</span> MicroAppStateActions <span class="token operator">=</span> <span class="token function">initGlobalState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>

actions<span class="token punctuation">.</span><span class="token function">onGlobalStateChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> prev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// state: 变更后的状态; prev 变更前的状态</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
actions<span class="token punctuation">.</span><span class="token function">setGlobalState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
actions<span class="token punctuation">.</span><span class="token function">offGlobalStateChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>微应用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 从生命周期 mount 中获取通信方法，使用方式和 master 一致</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  props<span class="token punctuation">.</span><span class="token function">onGlobalStateChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> prev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// state: 变更后的状态; prev 变更前的状态</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  props<span class="token punctuation">.</span><span class="token function">setGlobalState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <ul><li>微应用之间如何跳转？
主应用和微应用都是 hash 模式，主应用根据 hash 来判断微应用，则不用考虑这个问题。</li></ul> <p>主应用根据 path 来判断微应用</p> <p>history 模式的微应用之间的跳转，或者微应用跳主应用页面，直接使用微应用的路由实例是不行的，原因是微应用的路由实例跳转都基于路由的 base。有两种办法可以跳转：</p> <p>history.pushState()：mdn 用法介绍
将主应用的路由实例通过 props 传给微应用，微应用这个路由实例跳转。</p> <ul><li>微应用文件更新之后，访问的还是旧版文件
服务器需要给微应用的 index.html 配置一个响应头：Cache-Control no-cache，意思就是每次请求都检查是否更新。</li></ul> <p>以 Nginx 为例:</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> = /index.html</span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">add_header</span> Cache-Control no-cache</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>如何解决拉取微应用 entry 时 cookie 未携带的问题？
因为拉取微应用 entry 的请求都是跨域的，所以当你的微应用是依赖 cookie (如登陆鉴权)的情况下，你需要通过自定义 fetch 的方式，开启 fetch 的 cors 模式：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> start <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'qiankun'</span><span class="token punctuation">;</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 给指定的微应用 entry 开启跨域请求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'http://app.alipay.com/entry.html'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> window<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>args<span class="token punctuation">,</span>
        mode<span class="token operator">:</span> <span class="token string">'cors'</span><span class="token punctuation">,</span>
        credentials<span class="token operator">:</span> <span class="token string">'include'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> window<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/10/2021, 12:52:46 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.88154504.js" defer></script><script src="/blog/assets/js/2.312bc144.js" defer></script><script src="/blog/assets/js/62.9e462aef.js" defer></script>
  </body>
</html>
